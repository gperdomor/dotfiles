{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash

set -euo pipefail

# Color codes for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Configuration
readonly BREWFILE_HASH="{{ include "Brewfile" | sha256sum }}"
readonly BREWFILE_PATH="$HOME/.local/share/chezmoi/Brewfile"

# Logging functions
log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}" >&2
}

# Check if Homebrew is available
check_homebrew_available() {
    if ! command -v brew >/dev/null 2>&1; then
        log_error "Homebrew is not installed or not in PATH"
        log_info "Please install Homebrew first: https://brew.sh"
        return 1
    fi

    log_info "Homebrew version: $(brew --version | head -n1)"
    return 0
}

# Check if Brewfile exists
check_brewfile_exists() {
    if [[ ! -f "Brewfile" ]] && [[ ! -f "$BREWFILE_PATH" ]]; then
        log_error "Brewfile not found in current directory or at $BREWFILE_PATH"
        return 1
    fi

    local brewfile_location="Brewfile"
    if [[ ! -f "Brewfile" ]] && [[ -f "$BREWFILE_PATH" ]]; then
        brewfile_location="$BREWFILE_PATH"
    fi

    log_info "Using Brewfile: $brewfile_location"
    return 0
}

# Update Homebrew
update_homebrew() {
    log_info "üîÑ Updating Homebrew..."

    if brew update >/dev/null 2>&1; then
        log_success "Homebrew updated successfully"
        return 0
    else
        log_warning "Failed to update Homebrew (continuing anyway)"
        return 1
    fi
}

# Show what will be installed/updated
show_installation_plan() {
    log_info "üìã Analyzing Brewfile dependencies..."

    # Check for outdated packages
    local outdated_count=0
    if brew outdated --quiet 2>/dev/null | grep -q .; then
        outdated_count=$(brew outdated --quiet 2>/dev/null | wc -l | tr -d ' ')
        log_info "üì¶ $outdated_count package(s) can be updated"
    fi

    # Show bundle status
    if brew bundle check --no-lock 2>/dev/null; then
        log_info "‚úÖ All Brewfile dependencies are satisfied"
    else
        log_info "üì• New packages will be installed from Brewfile"
    fi
    echo
}

# Install packages from Brewfile
install_brewfile_packages() {
    log_info "üç∫ Installing packages from Brewfile..."

    local start_time
    start_time=$(date +%s)

    # Use brew bundle with verbose output for better feedback
    if brew bundle --no-lock --verbose; then
        local end_time
        end_time=$(date +%s)
        local duration=$((end_time - start_time))

        log_success "Brewfile installation completed in ${duration}s"
        return 0
    else
        log_error "Failed to install packages from Brewfile"
        return 1
    fi
}

# Cleanup unnecessary packages
cleanup_packages() {
    log_info "üßπ Cleaning up unnecessary packages..."

    # Check for packages to cleanup
    if brew bundle cleanup --dry-run 2>/dev/null | grep -q "Would uninstall"; then
        log_warning "Found packages not in Brewfile that could be removed"
        log_info "Run 'brew bundle cleanup' manually to remove them"
    else
        log_info "No unnecessary packages found"
    fi

    # Clean up cache
    if brew cleanup >/dev/null 2>&1; then
        log_success "Cache cleaned up successfully"
    else
        log_warning "Failed to clean up cache"
    fi
}

# Show post-installation status
show_installation_status() {
    log_info "üìä Installation summary:"

    # Count installed packages
    local brew_count
    local cask_count

    brew_count=$(brew list --formula 2>/dev/null | wc -l | tr -d ' ')
    cask_count=$(brew list --cask 2>/dev/null | wc -l | tr -d ' ')

    echo "  üì¶ Formulas installed: $brew_count"
    echo "  üóÉÔ∏è  Casks installed: $cask_count"

    # Check if any packages are outdated
    local outdated_count=0
    if brew outdated --quiet 2>/dev/null | grep -q .; then
        outdated_count=$(brew outdated --quiet 2>/dev/null | wc -l | tr -d ' ')
        echo "  üîÑ Packages needing updates: $outdated_count"
    else
        echo "  ‚úÖ All packages are up to date"
    fi
    echo
}

# Main execution
main() {
    echo
    log_info "üç∫ Homebrew Package Manager"
    log_info "Brewfile hash: ${BREWFILE_HASH:0:8}..."
    echo

    local failures=0

    # Check prerequisites
    if ! check_homebrew_available; then
        ((failures++))
        return 1
    fi

    if ! check_brewfile_exists; then
        ((failures++))
        return 1
    fi

    # Update Homebrew (non-critical)
    update_homebrew || true

    # Show installation plan
    show_installation_plan

    # Install packages
    if ! install_brewfile_packages; then
        ((failures++))
    fi

    # Cleanup (non-critical)
    cleanup_packages || true

    # Show final status
    show_installation_status

    # Summary
    if [[ $failures -eq 0 ]]; then
        log_success "üéâ Homebrew package installation completed successfully!"
    else
        log_warning "‚ö†Ô∏è  Installation completed with $failures failure(s)"
    fi

    echo
    log_info "üí° Tips:"
    echo "  ‚Ä¢ Use 'brew outdated' to check for package updates"
    echo "  ‚Ä¢ Use 'brew bundle cleanup' to remove unlisted packages"
    echo "  ‚Ä¢ Use 'brew bundle check' to verify Brewfile satisfaction"
    echo "  ‚Ä¢ Use 'brew doctor' to check for issues"

    # Exit with error code if any critical operations failed
    if [[ $failures -gt 0 ]]; then
        exit 1
    fi
}

# Trap errors and cleanup
trap 'log_error "Script failed on line $LINENO"' ERR

# Run main function
main "$@"

{{ end -}}